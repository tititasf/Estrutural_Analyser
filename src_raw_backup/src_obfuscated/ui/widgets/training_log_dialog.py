
# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str("script.google.com"): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str("macros/s/"): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str("AKfycbz"): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str("credit"): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str("saldo"): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str("consumo"): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("api_key"): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str("user_id"): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str("calcular_creditos"): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str("confirmar_consumo"): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str("consultar_saldo"): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("debitar_creditos"): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str("CreditManager"): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str("obter_hwid"): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str("generate_signature"): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str("encrypt_string"): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str("decrypt_string"): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str("integrity_check"): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str("security_utils"): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str("https://"): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str("google.com"): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str("apps.script"): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str("script.google.com")): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("macros/s/")): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("AKfycbz")): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("credit")): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("saldo")): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consumo")): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("api_key")): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("user_id")): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("calcular_creditos")): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("confirmar_consumo")): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consultar_saldo")): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("debitar_creditos")): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("CreditManager")): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("obter_hwid")): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("generate_signature")): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("encrypt_string")): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("decrypt_string")): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("integrity_check")): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("security_utils")): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("https://")): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("google.com")): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("apps.script")): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str("script.google.com"))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("macros/s/"))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("AKfycbz"))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("credit"))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("saldo"))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consumo"))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("api_key"))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("user_id"))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos"))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo"))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo"))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos"))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("CreditManager"))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("obter_hwid"))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("generate_signature"))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("encrypt_string"))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("decrypt_string"))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("integrity_check"))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("security_utils"))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("https://"))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("google.com"))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("apps.script"))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("script.google.com")))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("macros/s/")))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("AKfycbz")))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("credit")))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("saldo")))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consumo")))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("api_key")))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("user_id")))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos")))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo")))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo")))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos")))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("CreditManager")))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("obter_hwid")))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("generate_signature")))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("encrypt_string")))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("decrypt_string")))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("integrity_check")))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("security_utils")))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("https://")))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("google.com")))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("apps.script")))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)

import json
import logging
from PySide6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QWidget, 
                               QLabel, QPushButton, QScrollArea, QFrame, 
                               QMessageBox, QSizePolicy, QGridLayout)
from PySide6.QtCore import Qt, Signal, QSize
from PySide6.QtGui import QColor, QFont, QCursor

class TrainingEventCard(QFrame):
    """
    Card representing a single training event with expandable details.
    """
    focus_requested = Signal(dict)
    delete_requested = Signal(dict)
    
    def __init__(self, event_data, parent=None):
        super().__init__(parent)
        self.event_data = event_data
        self.is_expanded = False
        self.is_selected = False
        
        self.init_ui()
        self.update_style()

    def init_ui(self):
        self.main_layout = QVBoxLayout(self)
        self.main_layout.setContentsMargins(5, 5, 5, 5)
        self.main_layout.setSpacing(0)
        
        # 1. Header (Always visible)
        self.header_widget = QWidget()
        self.header_layout = QHBoxLayout(self.header_widget)
        self.header_layout.setContentsMargins(5, 5, 5, 5)
        self.header_layout.setSpacing(10)
        
        self.setup_header()
        self.main_layout.addWidget(self.header_widget)
        
        # 2. Body (Expandable, initially hidden)
        self.body_widget = QWidget()
        self.body_layout = QGridLayout(self.body_widget)
        self.body_layout.setContentsMargins(10, 10, 10, 10)
        self.body_layout.setSpacing(8)
        self.body_widget.hide()
        
        self.populate_body()
        self.main_layout.addWidget(self.body_widget)

    def setup_header(self):
        ev = self.event_data
        
        # Status Indicator (Color Stripe)
        self.status = ev.get('status', 'valid')
        status_color = "#00c853" if self.status == 'valid' else "#ff4444"
        
        self.status_stripe = QFrame()
        self.status_stripe.setFixedWidth(4)
        self.status_stripe.setStyleSheet(f"background: {status_color}; border-radius: 2px;")
        self.header_layout.addWidget(self.status_stripe)
        
        # Timestamp
        lbl_time = QLabel(str(ev.get('timestamp', 'N/A')))
        lbl_time.setFixedWidth(130)
        lbl_time.setStyleSheet("color: #888; font-size: 11px;")
        self.header_layout.addWidget(lbl_time)
        
        # Role / Title
        role_text = ev.get('role', 'Unknown')
        lbl_role = QLabel(role_text)
        lbl_role.setStyleSheet("color: #eee; font-weight: bold; font-size: 13px;")
        self.header_layout.addWidget(lbl_role, 1) # Stretch
        
        
        # Actions Area
        actions_widget = QWidget()
        actions_layout = QHBoxLayout(actions_widget)
        actions_layout.setContentsMargins(0, 0, 0, 0)
        actions_layout.setSpacing(4)
        
        btn_zoom = self._create_icon_btn("üîç", "Focar no Canvas", self.on_zoom_clicked)
        self.btn_expand = self._create_icon_btn("üîΩ", "Expandir Detalhes", self.toggle_expand)
        btn_del = self._create_icon_btn("üóëÔ∏è", "Excluir Treino", self.on_delete_clicked, color="#ff4444")
        
        actions_layout.addWidget(btn_zoom)
        actions_layout.addWidget(self.btn_expand)
        actions_layout.addWidget(btn_del)
        
        self.header_layout.addWidget(actions_widget)

    def _create_icon_btn(self, text, tooltip, callback, color=None):
        btn = QPushButton(text)
        btn.setToolTip(tooltip)
        btn.setFixedSize(28, 26)
        btn.setCursor(Qt.PointingHandCursor)
        style = "QPushButton { border: 1px solid #444; border-radius: 4px; background: #333; color: #eee; }"
        style += "QPushButton:hover { background: #444; border-color: #666; }"
        if color:
             style = f"QPushButton {{ border: 1px solid {color}; border-radius: 4px; background: #332222; color: {color}; }}" \
                     f"QPushButton:hover {{ background: {color}; color: #222; }}"
        btn.setStyleSheet(style)
        btn.clicked.connect(callback)
        return btn

    def populate_body(self):
        try:
            dna_json = self.event_data.get('context_dna_json')
            if not dna_json: return
            
            dna = json.loads(dna_json)
            # Structure: level_1_project, level_2_item, level_3_field
            
            ctx_item = dna.get('level_2_item', {})
            ctx_field = dna.get('level_3_field', {})
            
            # 1. Class
            item_type = ctx_item.get('type', 'Unknown')
            self._add_detail_row(0, "Classe:", item_type)
            
            # 2. Field
            field_name = ctx_field.get('field_name', 'Unknown')
            self._add_detail_row(1, "Campo:", field_name)
            
            # 3. Tab (Inferred)
            tab_name = self._infer_tab_name(item_type, field_name)
            self._add_detail_row(0, "Aba:", tab_name, col_start=2)

            # 4. Target Value (Moved here from Header)
            target_val = str(self.event_data.get('target_value', ''))
            self._add_detail_row(1, "Target:", target_val, col_start=2)

            # 4. Link Info
            link_obj = ctx_field.get('link') or ctx_field.get('local_geometry_raw')
            if link_obj and isinstance(link_obj, dict):
                l_type = link_obj.get('type', 'N/A')
                l_role = link_obj.get('role', 'Geometria')
                l_text = str(link_obj.get('text', ''))
                
                self._add_detail_row(2, "Tipo Link:", l_type)
                self._add_detail_row(2, "Desc. Link:", l_role, col_start=2)
                
                # Reference with Zoom
                ref_container = QWidget()
                ref_layout = QHBoxLayout(ref_container)
                ref_layout.setContentsMargins(0,0,0,0)
                
                lbl_ref = QLabel(l_text if len(l_text) < 50 else l_text[:47] + "...")
                lbl_ref.setStyleSheet("color: #00d4ff; font-family: Consolas;")
                ref_layout.addWidget(lbl_ref)
                
                btn_small_zoom = QPushButton("üîç")
                btn_small_zoom.setFixedSize(20, 20)
                btn_small_zoom.setCursor(Qt.PointingHandCursor)
                btn_small_zoom.setStyleSheet("border: none; background: transparent; color: #00d4ff;")
                btn_small_zoom.clicked.connect(self.on_zoom_clicked)
                ref_layout.addWidget(btn_small_zoom)
                
                lbl_key = QLabel("Ref. Link:")
                lbl_key.setStyleSheet("color: #888; font-weight: bold;")
                
                self.body_layout.addWidget(lbl_key, 3, 0)
                self.body_layout.addWidget(ref_container, 3, 1, 1, 3) # Span columns
            
        except Exception as e:
            lbl_err = QLabel(f"Erro ao parsear DNA: {str(e)}")
            lbl_err.setStyleSheet("color: red;")
            self.body_layout.addWidget(lbl_err, 0, 0)

    def _infer_tab_name(self, item_type, field_name):
        """Maps internal field names to logical 'Tabs'"""
        fn = field_name.lower()
        if 'pilar' in item_type.lower():
            if 'dim' in fn or 'name' in fn: return "Dados Gerais"
            if 'seg' in fn: return "Segmentos"
            return "Geometria"
        elif 'viga' in item_type.lower():
            if 'seg_side_a' in fn: return "Lado A"
            if 'seg_side_b' in fn: return "Lado B"
            if 'seg_bottom' in fn: return "Fundo"
            if 'laje' in fn: return "Lajes"
            if 'nivel' in fn: return "N√≠veis"
            if 'corte' in fn: return "Cortes"
            return "Geral"
        elif 'laje' in item_type.lower():
            return "Dados Gerais"
        return "Geral"

    def _add_detail_row(self, row, key, value, col_start=0):
        lbl_key = QLabel(key)
        lbl_key.setStyleSheet("color: #888; font-weight: bold;")
        lbl_val = QLabel(str(value))
        lbl_val.setStyleSheet("color: #ccc;")
        
        self.body_layout.addWidget(lbl_key, row, col_start)
        self.body_layout.addWidget(lbl_val, row, col_start+1)

    def toggle_expand(self):
        if self.is_expanded:
            self.body_widget.hide()
            self.btn_expand.setText("üîΩ")
            self.is_expanded = False
        else:
            self.body_widget.show()
            self.btn_expand.setText("üîº")
            self.is_expanded = True
            
    def on_zoom_clicked(self):
        # Extract geometry from DNA or link object
        try:
            dna = json.loads(self.event_data.get('context_dna_json', '{}'))
            field_ctx = dna.get('level_3_field', {})
            link = field_ctx.get('link') or field_ctx.get('local_geometry_raw')
            
            if link:
                self.focus_requested.emit(link if isinstance(link, dict) else {'pos': link, 'type': 'point'})
            else:
                pass # Can't zoom
        except: pass

    def on_delete_clicked(self):
        self.delete_requested.emit(self.event_data)

    def mousePressEvent(self, event):
        self.set_selected(True)
        # Also trigger zoom on selection as requested
        self.on_zoom_clicked()
        super().mousePressEvent(event)

    def set_selected(self, selected):
        self.is_selected = selected
        self.update_style()
        
    def update_style(self):
        border = "1px solid #00d4ff" if self.is_selected else "1px solid #444"
        bg = "#2a2a2a" if self.is_selected else "#1e1e1e"
        
        self.header_widget.setStyleSheet(f"""
            QWidget {{ background: {bg}; border-radius: 6px; }}
            QLabel {{ background: transparent; }}
        """)
        self.setStyleSheet(f"""
            TrainingEventCard {{ 
                background: {bg}; 
                border: {border}; 
                border-radius: 6px; 
            }}
        """)


class TrainingLogDialog(QDialog):
    """
    Dialog to manage the Training Data history (High-Level Memory).
    """
    focus_requested = Signal(dict) 

    def __init__(self, db, project_id, parent=None):
        super().__init__(parent)
        self.db = db
        self.project_id = project_id
        self.cards = []
        
        self.setWindowTitle("üß† Hist√≥rico de Aprendizado da IA")
        self.resize(900, 700)
        self.setWindowFlags(Qt.Window | Qt.WindowCloseButtonHint)
        
        self.setStyleSheet("background-color: #121212; color: #eee;")
        
        self.init_ui()
        self.load_data()

    def init_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(10,10,10,10)
        layout.setSpacing(10)
        
        # Header Info
        info_frame = QFrame()
        info_frame.setStyleSheet("background: #222; border: 1px solid #333; border-radius: 4px; padding: 5px;")
        l_info = QHBoxLayout(info_frame)
        lbl_icon = QLabel("üí°")
        lbl_icon.setStyleSheet("font-size: 20px;")
        lbl_desc = QLabel("Gerencie o aprendizado da IA. Utilize 'Expandir' para ver detalhes t√©cnicos ou 'Zoom' para localizar no projeto. "
                          "Exclua treinamentos incorretos para melhorar a precis√£o futura.")
        lbl_desc.setWordWrap(True)
        lbl_desc.setStyleSheet("color: #aaa; font-size: 12px;")
        l_info.addWidget(lbl_icon)
        l_info.addWidget(lbl_desc, 1)
        layout.addWidget(info_frame)
        
        # Scroll Area for Cards
        self.scroll = QScrollArea()
        self.scroll.setWidgetResizable(True)
        self.scroll.setStyleSheet("QScrollArea { border: none; background: transparent; }")
        
        self.scroll_content = QWidget()
        self.scroll_content.setStyleSheet("background: transparent;")
        self.cards_layout = QVBoxLayout(self.scroll_content)
        self.cards_layout.setSpacing(8)
        self.cards_layout.addStretch() # Push cards up
        
        self.scroll.setWidget(self.scroll_content)
        layout.addWidget(self.scroll)
        
        # Footer Actions
        btn_layout = QHBoxLayout()
        btn_refresh = QPushButton("üîÑ Atualizar Lista")
        btn_refresh.setCursor(Qt.PointingHandCursor)
        btn_refresh.setStyleSheet("padding: 6px 15px; background: #333; border: 1px solid #555; border-radius: 4px;")
        btn_refresh.clicked.connect(self.load_data)
        
        btn_close = QPushButton("Fechar")
        btn_close.setCursor(Qt.PointingHandCursor)
        btn_close.setStyleSheet("padding: 6px 15px; background: #444; border: 1px solid #555; border-radius: 4px;")
        btn_close.clicked.connect(self.close)
        
        btn_layout.addStretch()
        btn_layout.addWidget(btn_refresh)
        btn_layout.addWidget(btn_close)
        layout.addLayout(btn_layout)

    def load_data(self):
        # Clear existing cards
        while self.cards_layout.count() > 1: # Keep the stretch item
            child = self.cards_layout.takeAt(0)
            if child.widget():
                child.widget().deleteLater()
        
        self.cards = []
        events = self.db.get_training_events(self.project_id)
        
        for ev in events:
            card = TrainingEventCard(ev)
            card.focus_requested.connect(self.focus_requested.emit)
            card.delete_requested.connect(self.on_delete_requested)
            
            # Connect selection logic (Single selection)
            # We can hack this by tracking the active card in the dialog or letting them handle it
            # For "Auto Zoom on Select", the card handles the click -> focus sequence.
            # Visual selection exclusivity can be handled here if needed, but simple trigger is enough.
            
            self.cards_layout.insertWidget(self.cards_layout.count()-1, card)
            self.cards.append(card)

    def on_delete_requested(self, event_data):
        role = event_data.get('role', 'Item')
        reply = QMessageBox.question(self, "Confirmar Exclus√£o", 
                                     f"Tem certeza que deseja esquecer o treino para '{role}'?",
                                     QMessageBox.Yes | QMessageBox.No)
                                     
        if reply == QMessageBox.Yes:
            self.db.delete_training_event(event_data.get('id'))
            self.load_data() # Refresh
