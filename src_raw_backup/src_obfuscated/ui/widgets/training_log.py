
# Helper de ofuscaÃ§Ã£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str("script.google.com"): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str("macros/s/"): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str("AKfycbz"): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str("credit"): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str("saldo"): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str("consumo"): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("api_key"): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str("user_id"): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str("calcular_creditos"): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str("confirmar_consumo"): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str("consultar_saldo"): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("debitar_creditos"): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str("CreditManager"): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str("obter_hwid"): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str("generate_signature"): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str("encrypt_string"): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str("decrypt_string"): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str("integrity_check"): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str("security_utils"): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str("https://"): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str("google.com"): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str("apps.script"): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofuscaÃ§Ã£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str("script.google.com")): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("macros/s/")): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("AKfycbz")): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("credit")): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("saldo")): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consumo")): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("api_key")): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("user_id")): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("calcular_creditos")): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("confirmar_consumo")): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consultar_saldo")): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("debitar_creditos")): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("CreditManager")): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("obter_hwid")): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("generate_signature")): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("encrypt_string")): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("decrypt_string")): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("integrity_check")): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("security_utils")): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("https://")): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("google.com")): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("apps.script")): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofuscaÃ§Ã£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str("script.google.com"))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("macros/s/"))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("AKfycbz"))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("credit"))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("saldo"))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consumo"))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("api_key"))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("user_id"))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos"))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo"))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo"))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos"))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("CreditManager"))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("obter_hwid"))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("generate_signature"))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("encrypt_string"))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("decrypt_string"))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("integrity_check"))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("security_utils"))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("https://"))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("google.com"))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("apps.script"))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofuscaÃ§Ã£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("script.google.com")))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("macros/s/")))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("AKfycbz")))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("credit")))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("saldo")))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consumo")))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("api_key")))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("user_id")))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos")))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo")))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo")))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos")))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("CreditManager")))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("obter_hwid")))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("generate_signature")))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("encrypt_string")))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("decrypt_string")))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("integrity_check")))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("security_utils")))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("https://")))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("google.com")))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("apps.script")))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)

import json
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QLabel, 
                               QPushButton, QScrollArea, QFrame, QMessageBox, 
                               QGridLayout, QSizePolicy)
from PySide6.QtCore import Qt, Signal, QSize
from PySide6.QtGui import QColor, QCursor

class TrainingEventCard(QFrame):
    """
    Card representing a single training event with expandable details.
    Redesigned for 2-line header and neon aesthetics.
    """
    focus_requested = Signal(dict)
    delete_requested = Signal(dict)
    
    def __init__(self, event_data, parent=None):
        super().__init__(parent)
        self.event_data = event_data
        self.is_expanded = False
        self.is_selected = False
        
        self.init_ui()
        self.update_style()

    def init_ui(self):
        self.main_layout = QVBoxLayout(self)
        self.main_layout.setContentsMargins(8, 8, 8, 8)
        self.main_layout.setSpacing(6)
        
        # --- HEADER (2 Lines) ---
        self.header_widget = QWidget()
        self.header_layout = QVBoxLayout(self.header_widget)
        self.header_layout.setContentsMargins(0, 0, 0, 0)
        self.header_layout.setSpacing(4)
        
        # Line 1: Timestamp + Status Stripe (Integrated visually)
        line1_layout = QHBoxLayout()
        line1_layout.setSpacing(8)
        
        # Status (Color Stripe)
        self.status = self.event_data.get('status', 'valid')
        status_color = "#00ff88" if self.status == 'valid' else "#ff4444"
        
        self.status_stripe = QFrame()
        self.status_stripe.setFixedSize(8, 8)
        self.status_stripe.setStyleSheet(f"background: {status_color}; border-radius: 4px;")
        line1_layout.addWidget(self.status_stripe)
        
        # Timestamp
        ts = str(self.event_data.get('timestamp', 'N/A'))
        lbl_time = QLabel(ts.split('.')[0]) # Remove millis if present
        lbl_time.setStyleSheet("color: #666; font-size: 10px; font-weight: bold;")
        line1_layout.addWidget(lbl_time)
        line1_layout.addStretch()
        
        self.header_layout.addLayout(line1_layout)
        
        # Line 2: Role + Buttons
        line2_layout = QHBoxLayout()
        line2_layout.setSpacing(10)
        
        # Role / Title
        role_text = self.event_data.get('role', 'Unknown')
        lbl_role = QLabel(role_text)
        lbl_role.setStyleSheet("color: #eee; font-weight: bold; font-size: 14px;")
        line2_layout.addWidget(lbl_role, 1) # Stretch
        
        # Actions Buttons
        btns_widget = QWidget()
        btns_layout = QHBoxLayout(btns_widget)
        btns_layout.setContentsMargins(0, 0, 0, 0)
        btns_layout.setSpacing(6)
        
        self.btn_zoom = self._create_mini_btn("ðŸ”", "Focar no Canvas", self.on_zoom_clicked)
        self.btn_expand = self._create_mini_btn("ðŸ”½", "Detalhes", self.toggle_expand)
        self.btn_del = self._create_mini_btn("ðŸ—‘ï¸", "Excluir", self.on_delete_clicked, color="#ff4444")
        
        btns_layout.addWidget(self.btn_zoom)
        btns_layout.addWidget(self.btn_expand)
        btns_layout.addWidget(self.btn_del)
        
        line2_layout.addWidget(btns_widget)
        self.header_layout.addLayout(line2_layout)
        
        self.main_layout.addWidget(self.header_widget)
        
        # --- BODY (Expandable) ---
        self.body_widget = QWidget()
        self.body_layout = QGridLayout(self.body_widget)
        self.body_layout.setContentsMargins(4, 4, 4, 4)
        self.body_layout.setSpacing(6)
        self.body_widget.hide()
        
        self.populate_body()
        self.main_layout.addWidget(self.body_widget)

    def _create_mini_btn(self, icon_text, tooltip, callback, color="#00d4ff"):
        btn = QPushButton(icon_text)
        btn.setToolTip(tooltip)
        btn.setFixedSize(24, 24)
        btn.setCursor(Qt.PointingHandCursor)
        
        # Mini Style (Cleaner, less aggressive neon)
        style = f"""
            QPushButton {{
                background-color: transparent;
                border: 1px solid {color}66;
                border-radius: 4px;
                color: {color};
                font-size: 11px;
                padding: 0px;
                font-weight: bold;
            }}
            QPushButton:hover {{
                background-color: {color}22;
                border: 1px solid {color};
            }}
            QPushButton:pressed {{
                background-color: {color}44;
            }}
        """
        btn.setStyleSheet(style)
        btn.clicked.connect(callback)
        return btn

    def populate_body(self):
        try:
            dna_json = self.event_data.get('context_dna_json')
            if not dna_json: return
            
            dna = json.loads(dna_json)
            
            ctx_item = dna.get('level_2_item', {})
            ctx_field = dna.get('level_3_field', {})
            
            # Rows
            self._add_detail_row(0, "Classe:", ctx_item.get('type', 'N/A'))
            self._add_detail_row(1, "Campo:", ctx_field.get('field_name', 'N/A'))
            
            target_val = str(self.event_data.get('target_value', ''))
            self._add_detail_row(2, "Valor (Target):", target_val)

            # Link Info
            link_obj = ctx_field.get('link') or ctx_field.get('local_geometry_raw')
            if link_obj and isinstance(link_obj, dict):
                l_type = link_obj.get('type', 'N/A')
                l_text = str(link_obj.get('text', ''))
                self._add_detail_row(3, "Link Tipo:", l_type)
                
                # Full Reference Text
                lbl_ref = QLabel(l_text)
                lbl_ref.setWordWrap(True)
                lbl_ref.setStyleSheet("color: #00d4ff; font-family: Consolas; font-size: 10px;")
                self.body_layout.addWidget(QLabel("Ref:"), 4, 0)
                self.body_layout.addWidget(lbl_ref, 4, 1)

        except Exception as e:
            lbl_err = QLabel(str(e))
            lbl_err.setStyleSheet("color: red;")
            self.body_layout.addWidget(lbl_err, 0, 0)

    def _add_detail_row(self, row, key, value):
        lbl_key = QLabel(key)
        lbl_key.setStyleSheet("color: #777; font-weight: bold; font-size: 10px;")
        lbl_val = QLabel(str(value))
        lbl_val.setStyleSheet("color: #bbb; font-size: 10px;")
        self.body_layout.addWidget(lbl_key, row, 0)
        self.body_layout.addWidget(lbl_val, row, 1)

    def toggle_expand(self):
        if self.is_expanded:
            self.body_widget.hide()
            self.btn_expand.setText("ðŸ”½")
            self.is_expanded = False
        else:
            self.body_widget.show()
            self.btn_expand.setText("ðŸ”¼")
            self.is_expanded = True
            
    def on_zoom_clicked(self):
        # Extract link data
        try:
            dna = json.loads(self.event_data.get('context_dna_json', '{}'))
            
            # 1. Tentar Link EspecÃ­fico do Campo (Mais preciso - Link ou Geometria Local)
            field_ctx = dna.get('level_3_field', {})
            link = field_ctx.get('link') or field_ctx.get('local_geometry_raw')
            
            if link:
                payload = link if isinstance(link, dict) else {'pos': link, 'type': 'point'}
                print(f"[DEBUG] Zooming to Field Link: {payload}")
                self.focus_requested.emit(payload)
                return

            # 2. Fallback: Tentar PosiÃ§Ã£o do Item Pai (Se o link especÃ­fico falhar/nÃ£o existir)
            # Isso resolve o caso de dados antigos ou onde apenas o item foi registrado sem detalhe de campo.
            item_ctx = dna.get('level_2_item', {})
            item_pos = item_ctx.get('pos')
            if item_pos:
                 payload = {'pos': item_pos, 'type': 'point', 'text': item_ctx.get('name', 'Item')}
                 print(f"[DEBUG] Zooming to Item Fallback: {payload}")
                 self.focus_requested.emit(payload)
                 return
                 
            print("[DEBUG] No zoomable data found in event DNA (Checked Field & Item)")
            
        except Exception as e:
            print(f"[DEBUG] Error extracting link for zoom: {e}")

    def on_delete_clicked(self):
        self.delete_requested.emit(self.event_data)

    def mousePressEvent(self, event):
        # Optional: Select card on click
        self.set_selected(True)
        super().mousePressEvent(event)

    def set_selected(self, selected):
        self.is_selected = selected
        self.update_style()
        
    def update_style(self):
        border_color = "#00d4ff" if self.is_selected else "#333"
        bg_color = "#1a1a1a"
        
        self.setStyleSheet(f"""
            TrainingEventCard {{
                background-color: {bg_color};
                border: 1px solid {border_color};
                border-radius: 6px;
            }}
        """)
        self.header_widget.setStyleSheet("background: transparent;")


class TrainingLog(QWidget):
    sync_requested = Signal()
    focus_requested = Signal(dict)

    def __init__(self, db_manager):
        super().__init__()
        self.db = db_manager
        self.current_project_id = None
        self.setup_ui()
    
    def setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        
        # --- Top Bar ---
        top_bar = QFrame()
        top_bar.setStyleSheet("background: #111; border-bottom: 1px solid #333;")
        top_layout = QHBoxLayout(top_bar)
        
        lbl_title = QLabel("ðŸ§  Feedback de Treino")
        lbl_title.setStyleSheet("font-weight: bold; font-size: 13px; color: #fff;")
        
        # O botÃ£o de Sync processa os logs locais e os insere na memÃ³ria vetorial
        # Isso "efetiva" o aprendizado para novas prediÃ§Ãµes.
        self.btn_sync = QPushButton("Efetivar (Sync)")
        self.btn_sync.setToolTip("Transforma este histÃ³rico em inteligÃªncia ativa (Vector DB) para melhorar prediÃ§Ãµes futuras.")
        self.btn_sync.clicked.connect(self.sync_requested.emit)
        self.btn_sync.setStyleSheet("background: #d63384; border: none; padding: 4px 10px; border-radius: 4px; color: white; font-size: 11px;")
        
        top_layout.addWidget(lbl_title)
        top_layout.addStretch()
        top_layout.addWidget(self.btn_sync)
        layout.addWidget(top_bar)

        # --- Content Area ---
        self.scroll = QScrollArea()
        self.scroll.setWidgetResizable(True)
        self.scroll.setStyleSheet("QScrollArea { border: none; background: #000; }")
        
        self.scroll_content = QWidget()
        self.scroll_content.setStyleSheet("background: #000;")
        self.cards_layout = QVBoxLayout(self.scroll_content)
        self.cards_layout.setSpacing(10)
        self.cards_layout.setContentsMargins(10, 10, 10, 10)
        self.cards_layout.addStretch() 
        
        self.scroll.setWidget(self.scroll_content)
        layout.addWidget(self.scroll)
        
        # --- Footer ---
        footer = QFrame()
        footer.setStyleSheet("background: #111; border-top: 1px solid #333;")
        f_layout = QHBoxLayout(footer)
        
        btn_refresh = QPushButton("ðŸ”„ Atualizar Lista")
        btn_refresh.setCursor(Qt.PointingHandCursor)
        btn_refresh.setStyleSheet("background: #222; border: 1px solid #444; color: #ccc; padding: 6px 12px; border-radius: 4px;")
        btn_refresh.clicked.connect(self.refresh_list)
        
        f_layout.addStretch()
        f_layout.addWidget(btn_refresh)
        layout.addWidget(footer)

    def refresh_list(self):
        if self.current_project_id:
            self.load_events(self.current_project_id)
        else:
            print("[DEBUG] Cannot refresh: No active project ID")

    def load_events(self, project_id):
        self.current_project_id = project_id
        
        # Clear existing items
        while self.cards_layout.count() > 1:
            child = self.cards_layout.takeAt(0)
            if child.widget():
                child.widget().deleteLater()
        
        if not project_id: return

        events = self.db.get_training_events(project_id)
        
        for ev in events:
            card = TrainingEventCard(ev)
            card.focus_requested.connect(self.focus_requested.emit)
            card.delete_requested.connect(self.on_delete_requested)
            
            # Insert before the stretch item
            self.cards_layout.insertWidget(self.cards_layout.count()-1, card)

    def on_delete_requested(self, event_data):
        role = event_data.get('role', 'Item')
        reply = QMessageBox.question(self, "Esquecer Treino?", 
                                     f"Remover aprendizado para '{role}'?",
                                     QMessageBox.Yes | QMessageBox.No)
                                     
        if reply == QMessageBox.Yes:
            self.db.delete_training_event(event_data.get('id'))
            self.refresh_list()
