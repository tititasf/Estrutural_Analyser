
# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str("script.google.com"): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str("macros/s/"): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str("AKfycbz"): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str("credit"): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str("saldo"): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str("consumo"): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("api_key"): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str("user_id"): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str("calcular_creditos"): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str("confirmar_consumo"): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str("consultar_saldo"): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("debitar_creditos"): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str("CreditManager"): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str("obter_hwid"): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str("generate_signature"): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str("encrypt_string"): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str("decrypt_string"): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str("integrity_check"): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str("security_utils"): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str("https://"): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str("google.com"): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str("apps.script"): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str("script.google.com")): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("macros/s/")): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("AKfycbz")): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("credit")): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("saldo")): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consumo")): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("api_key")): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("user_id")): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("calcular_creditos")): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("confirmar_consumo")): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consultar_saldo")): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("debitar_creditos")): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("CreditManager")): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("obter_hwid")): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("generate_signature")): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("encrypt_string")): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("decrypt_string")): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("integrity_check")): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("security_utils")): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("https://")): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("google.com")): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("apps.script")): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str("script.google.com"))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("macros/s/"))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("AKfycbz"))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("credit"))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("saldo"))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consumo"))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("api_key"))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("user_id"))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos"))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo"))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo"))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos"))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("CreditManager"))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("obter_hwid"))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("generate_signature"))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("encrypt_string"))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("decrypt_string"))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("integrity_check"))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("security_utils"))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("https://"))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("google.com"))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("apps.script"))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("script.google.com")))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("macros/s/")))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("AKfycbz")))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("credit")))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("saldo")))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consumo")))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("api_key")))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("user_id")))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos")))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo")))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo")))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos")))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("CreditManager")))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("obter_hwid")))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("generate_signature")))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("encrypt_string")))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("decrypt_string")))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("integrity_check")))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("security_utils")))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("https://")))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("google.com")))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("apps.script")))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("script.google.com"))))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("macros/s/"))))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("AKfycbz"))))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("credit"))))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("saldo"))))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consumo"))))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("api_key"))))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("user_id"))))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos"))))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo"))))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo"))))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos"))))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("CreditManager"))))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("obter_hwid"))))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("generate_signature"))))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("encrypt_string"))))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("decrypt_string"))))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("integrity_check"))))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("security_utils"))))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("https://"))))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("google.com"))))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("apps.script"))))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)

import logging
from typing import Dict, List, Any
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QLabel, 
                                QFrame, QScrollArea, QTabWidget, QGridLayout, 
                                QTableWidget, QTableWidgetItem, QHeaderView, QPushButton, QProgressBar)
from PySide6.QtCore import Qt, QSize
from PySide6.QtCharts import QChart, QChartView, QPieSeries, QBarSeries, QBarSet, QBarCategoryAxis, QValueAxis
from PySide6.QtGui import QPainter, QLinearGradient, QColor, QGradient
from src.ui.dialogs.project_details_dialog import ProjectDetailsDialog

class DashboardCard(QFrame):
    def __init__(self, title: str, value: str, subtext: str = "", color: str = "#007acc"):
        super().__init__()
        self.setObjectName("DashboardCard")
        self.setFrameShape(QFrame.StyledPanel)
        
        layout = QVBoxLayout(self)
        
        lbl_title = QLabel(title)
        lbl_title.setStyleSheet("color: #888; font-size: 14px; font-weight: bold;")
        layout.addWidget(lbl_title)
        
        self.lbl_value = QLabel(value)
        self.lbl_value.setStyleSheet(f"color: {color}; font-size: 32px; font-weight: bold; margin-top: 5px;")
        layout.addWidget(self.lbl_value)
        
        if subtext:
            lbl_sub = QLabel(subtext)
            lbl_sub.setStyleSheet("color: #666; font-size: 12px;")
            layout.addWidget(lbl_sub)
            
        self.setStyleSheet(f"""
            #DashboardCard {{
                background-color: #252525;
                border-radius: 12px;
                padding: 15px;
                border: 1px solid #333;
            }}
            #DashboardCard:hover {{
                border: 1px solid {color};
            }}
        """)

class AdminDashboard(QWidget):
    def __init__(self, db_manager, memory_manager=None):
        super().__init__()
        self.db = db_manager
        self.memory = memory_manager
        self.setup_ui()
        self.refresh_data()

    def setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        header = QLabel("üõ°Ô∏è Hub do Administrador - Intelig√™ncia da Comunidade")
        header.setStyleSheet("font-size: 24px; font-weight: bold; color: #007acc;")
        layout.addWidget(header)
        
        self.tabs = QTabWidget()
        self.tabs.setStyleSheet("""
            QTabWidget::pane { border: 1px solid #333; background: #1a1a1a; border-radius: 8px; }
            QTabBar::tab { background: #252525; padding: 12px 25px; color: #888; font-weight: bold; }
            QTabBar::tab:selected { background: #007acc; color: white; border-bottom: 2px solid #fff; }
        """)
        
        # 0. Community Projects List (Existing logic moved here)
        self.curadoria_tab = QWidget()
        self.setup_curadoria_tab()
        self.tabs.addTab(self.curadoria_tab, "üìã Lista de Curadoria")

        # 1. Database Dashboard
        self.db_tab = QWidget()
        self.setup_db_tab()
        self.tabs.addTab(self.db_tab, "üìä Banco de Dados")
        
        # 2. Vector Intelligence
        self.vector_tab = QWidget()
        self.setup_vector_tab()
        self.tabs.addTab(self.vector_tab, "üß† Mem√≥ria Vetorial")
        
        # 3. Accuracy & Comprehension
        self.accuracy_tab = QWidget()
        self.setup_accuracy_tab()
        self.tabs.addTab(self.accuracy_tab, "üéØ Acur√°cia & IA")
        
        layout.addWidget(self.tabs)

    def setup_curadoria_tab(self):
        layout = QVBoxLayout(self.curadoria_tab)
        
        info = QLabel("üõ°Ô∏è Projetos sincronizados pela comunidade para valida√ß√£o e treino global.")
        info.setStyleSheet("font-style: italic; color: #888; margin-bottom: 5px;")
        layout.addWidget(info)
        
        self.comm_table = QTableWidget()
        self.comm_table.setColumnCount(9)
        # Headers Atualizados
        headers = ["Projeto", "Obra", "Usu√°rio", "Criado em", 
                   "Itens (Azul / Total)", "V√≠nculos (Verde / Total)", 
                   "Treino (Itens)", "Treino (V√≠nculos)", "A√ß√µes"]
        self.comm_table.setHorizontalHeaderLabels(headers)
        
        # Ajuste de Colunas (Layout Proporcional)
        header = self.comm_table.horizontalHeader()
        header.setSectionResizeMode(QHeaderView.Interactive) # Base
        
        # 0: Projeto (Pequeno - ResizeToContents)
        header.setSectionResizeMode(0, QHeaderView.ResizeToContents) 
        
        # 1: Obra (Stretch - Preenche espa√ßo)
        header.setSectionResizeMode(1, QHeaderView.Stretch)
        
        # 2: Usu√°rio (ResizeToContents)
        header.setSectionResizeMode(2, QHeaderView.ResizeToContents)
        
        # 3: Data (Fixo)
        self.comm_table.setColumnWidth(3, 110)
        
        # 4: Itens (Stretch fator 2)
        header.setSectionResizeMode(4, QHeaderView.Stretch)
        # 5: V√≠nculos (Stretch fator 2)
        header.setSectionResizeMode(5, QHeaderView.Stretch)
        
        # 6 & 7: Treino (Stretch fator 1)
        header.setSectionResizeMode(6, QHeaderView.Stretch)
        header.setSectionResizeMode(7, QHeaderView.Stretch)
        
        # 8: A√ß√µes (Fixo)
        self.comm_table.setColumnWidth(8, 160)
        
        layout.addWidget(self.comm_table)
        
        btn_refresh = QPushButton("üîÑ Atualizar Lista de Curadoria")
        btn_refresh.clicked.connect(self.load_community_projects)
        layout.addWidget(btn_refresh)

    def setup_db_tab(self):
        layout = QVBoxLayout(self.db_tab)
        
        # Cards row
        self.cards_layout = QGridLayout()
        layout.addLayout(self.cards_layout)
        
        # Chart placeholder
        self.db_chart_view = QChartView()
        self.db_chart_view.setRenderHint(QPainter.Antialiasing)
        self.db_chart_view.setStyleSheet("background-color: transparent; border: 1px solid #333; border-radius: 8px;")
        layout.addWidget(self.db_chart_view)

    def setup_vector_tab(self):
        layout = QVBoxLayout(self.vector_tab)
        self.vector_info = QLabel("Calculando volume de embeddings...")
        self.vector_info.setWordWrap(True)
        layout.addWidget(self.vector_info)
        
        self.vector_chart_view = QChartView()
        layout.addWidget(self.vector_chart_view)

    def setup_accuracy_tab(self):
        layout = QVBoxLayout(self.accuracy_tab)
        
        info = QLabel("Compreens√£o do Sistema: Como a IA interpreta os v√≠nculos estruturais.")
        info.setStyleSheet("font-weight: bold; font-size: 16px; margin-bottom: 10px;")
        layout.addWidget(info)
        
        # Strategic Summary
        self.lbl_explanation = QLabel("Carregando an√°lise estrat√©gica...")
        self.lbl_explanation.setStyleSheet("background: #252525; padding: 15px; border-radius: 8px; color: #ccc;")
        self.lbl_explanation.setWordWrap(True)
        layout.addWidget(self.lbl_explanation)
        
        self.accuracy_chart_view = QChartView()
        layout.addWidget(self.accuracy_chart_view)

    def refresh_data(self):
        stats = self.db.get_admin_stats()
        accuracy = self.db.get_accuracy_report()
        
        # Update DB Cards
        for i in reversed(range(self.cards_layout.count())):
            self.cards_layout.itemAt(i).widget().setParent(None)
            
        self.cards_layout.addWidget(DashboardCard("Obras Ativas", str(stats.get('total_works', 0))), 0, 0)
        self.cards_layout.addWidget(DashboardCard("Total Projetos", str(stats.get('total_projects', 0))), 0, 1)
        self.cards_layout.addWidget(DashboardCard("Pilares", f"{stats.get('valid_pillars')}/{stats.get('total_pillars')}", "Validados"), 0, 2)
        self.cards_layout.addWidget(DashboardCard("Vigas", f"{stats.get('valid_beams')}/{stats.get('total_beams')}", "Validados", "#28a745"), 1, 0)
        self.cards_layout.addWidget(DashboardCard("Lajes", f"{stats.get('valid_slabs')}/{stats.get('total_slabs')}", "Validados", "#fd7e14"), 1, 1)

        # Update DB Bars
        series = QBarSeries()
        set_total = QBarSet("Total de Itens")
        set_valid = QBarSet("Validados")
        
        set_total.append([stats.get('total_pillars', 0), stats.get('total_beams', 0), stats.get('total_slabs', 0)])
        set_valid.append([stats.get('valid_pillars', 0), stats.get('valid_beams', 0), stats.get('valid_slabs', 0)])
        
        series.append(set_total)
        series.append(set_valid)
        
        chart = QChart()
        chart.addSeries(series)
        chart.setTitle("Comparativo de Produ√ß√£o da Comunidade")
        chart.setAnimationOptions(QChart.SeriesAnimations)
        
        categories = ["Pilares", "Vigas", "Lajes"]
        axis_x = QBarCategoryAxis()
        axis_x.append(categories)
        chart.addAxis(axis_x, Qt.AlignBottom)
        series.attachAxis(axis_x)
        
        axis_y = QValueAxis()
        chart.addAxis(axis_y, Qt.AlignLeft)
        series.attachAxis(axis_y)
        
        chart.setBackgroundVisible(False)
        chart.setTitleBrush(QColor("#fff"))
        chart.legend().setLabelColor(QColor("#fff"))
        
        self.db_chart_view.setChart(chart)

        # Update Vector Dashboard
        if self.memory:
            local_count = 0
            if self.memory.local_collection:
                local_count = self.memory.local_collection.count()
            
            global_count = 0
            if self.memory.global_collection:
                global_count = self.memory.global_collection.count()
                
            self.vector_info.setText(f"Intelig√™ncia Distribu√≠da: {local_count} embeddings locais | {global_count} globais.")
            
            pie = QPieSeries()
            pie.append("Local Intelligence", local_count)
            pie.append("Global Experience", global_count)
            
            v_chart = QChart()
            v_chart.addSeries(pie)
            v_chart.setTitle("Distribui√ß√£o de Peso da Mem√≥ria")
            v_chart.setBackgroundVisible(False)
            v_chart.setTitleBrush(QColor("#fff"))
            self.vector_chart_view.setChart(v_chart)

        # Accuracy Explanation
        explanation = (
            "<b>Estrat√©gia de Compreens√£o:</b><br><br>"
            "1. <b>V√≠nculos Pilar-Viga:</b> A IA utiliza um raio de busca din√¢mico (800px base) ajustado por 'Learned Offsets'. "
            "Se o sistema detecta falha repetitiva em um pilar espec√≠fico, o vetor de 'DNA' √© atualizado globalmente.<br>"
            "2. <b>Vetores de Atributos:</b> Cada campo (ex: Se√ß√£o, Nome) possui um slot de confian√ßa. "
            "Atualmente, a taxa de acerto em nomes de vigas √© a mais alta devido √† padroniza√ß√£o de prefixos.<br>"
            "3. <b>Feedback Loop:</b> Toda valida√ß√£o manual alimenta o ChromaDB, refinando a similaridade de cosseno para futuros projetos."
        )
        self.lbl_explanation.setText(explanation)
        
        # Accuracy Chart
        a_series = QPieSeries()
        success = sum(a['count'] for a in accuracy if a['status'] == 'valid')
        errors = sum(a['count'] for a in accuracy if a['status'] == 'error')
        
        a_series.append("Acertos Confirmados", success)
        a_series.append("Ajustes Manuais", errors)
        
        a_chart = QChart()
        a_chart.addSeries(a_series)
        a_chart.setTitle("Taxa de Precis√£o da IA (Active Learning)")
        a_chart.setBackgroundVisible(False)
        a_chart.setTitleBrush(QColor("#fff"))
        self.accuracy_chart_view.setChart(a_chart)

    def import_for_training(self, project_id, total_items_fallback):
        """Simula a importa√ß√£o para treino e atualiza o banco com estat√≠sticas reais (Itens e Links)."""
        print(f"Importing project {project_id} for training...")
        
        from src.core.services.sync_service import SyncService
        from datetime import datetime
        
        try:
            sync = SyncService()
            
            # 1. Fetch current full metadata
            res = sync.supabase.table("cloud_projects").select("metadata").eq("id", project_id).single().execute()
            current_meta = res.data.get('metadata') or {}
            
            # 2. Calculate Stats (Items)
            pillars = current_meta.get('pillars', []) or []
            beams = current_meta.get('beams', []) or []
            slabs = current_meta.get('slabs', []) or []
            
            all_items = pillars + beams + slabs
            total_items = len(all_items)
            
            # 3. Calculate Stats (Links/Fields)
            total_links_expected = 0
            total_links_validated = 0
            
            # Blue Items (Fully Validated)
            fully_valid = 0
            
            for item in all_items:
                # Item Validation (Blue Seal)
                if item.get('is_fully_validated'):
                    fully_valid += 1
                
                # Link Validation (Green Seal context)
                # Define expected fields per type
                # Pillar: ~12, Beam: ~10, Slab: ~6
                itype = 'pillar' # default
                if 'section' in item: itype = 'pillar' # heuristic
                elif 'points' in item: itype = 'slab'
                else: itype = 'beam'

                expected = 10 # generic average if unknown
                if itype == 'pillar': expected = 12
                elif itype == 'slab': expected = 6
                elif itype == 'beam': expected = 10
                
                total_links_expected += expected
                
                # Count validated fields (Keys in 'validated_fields' dict)
                v_fields = item.get('validated_fields', {})
                # Count 'na_fields' (Keys in 'na_fields' dict) - New Requirement
                na_fields = item.get('na_fields', {})
                
                # Combine unique keys from both valid and NA (overlap shouldn't happen but set handles it)
                valid_keys = set(v_fields.keys()) | set(na_fields.keys())
                total_links_validated += len(valid_keys)

            print(f"Stats: Items={fully_valid}/{total_items}, Links={total_links_validated}/{total_links_expected}")

            # 4. Update Metadata
            current_meta['last_training_at'] = datetime.now().isoformat()
            
            # Stats Block
            current_meta['stats'] = {
                'total_items': total_items,
                'blue_items': fully_valid,
                'total_links': total_links_expected,
                'green_links': total_links_validated
            }
            # Legacy fields for backward compat
            current_meta['training_items_count'] = total_items
            current_meta['fully_validated_count'] = fully_valid
            
            # 5. Push update
            sync.supabase.table("cloud_projects").update({"metadata": current_meta}).eq("id", project_id).execute()
            
            # Refresh UI
            self.load_community_projects()
        except Exception as e:
            print(f"Error importing: {e}")
            import traceback
            traceback.print_exc()

    def _create_progress_bar(self, value: int, total: int, color_full="#00d4ff", color_partial="#28a745"):
        """Helper para criar barra de progresso com texto 'Val / Total'"""
        pct = 0
        if total > 0:
            pct = (value / total) * 100
        
        pbar = QProgressBar()
        pbar.setRange(0, 100)
        pbar.setValue(int(pct))
        pbar.setFormat(f"{value}/{total} ({int(pct)}%)")
        pbar.setAlignment(Qt.AlignCenter)
        
        # Cor baseada na completude (Azul se 100%, Verde se parcial)
        chunk_color = color_full if pct >= 100 else color_partial
        
        pbar.setStyleSheet(f"""
            QProgressBar {{ 
                border: 0px; border-radius: 2px; text-align: center; color: #fff; background: #333;
                font-size: 10px; font-weight: bold;
            }}
            QProgressBar::chunk {{ 
                background-color: {chunk_color}; 
            }}
        """)
        return pbar

    def load_community_projects(self):
        """Busca projetos da nuvem para curadoria."""
        from src.core.services.sync_service import SyncService
        sync = SyncService()
        projects = sync.list_community_projects()
        
        self.comm_table.setRowCount(0)
        for row, p in enumerate(projects):
            self.comm_table.insertRow(row)
            
            try:
                # 0: Nome Projeto
                p_name = str(p.get('project_name') or p.get('name') or 'Sem Nome')
                self.comm_table.setItem(row, 0, QTableWidgetItem(p_name))
                
                # 1: Obra
                meta = p.get('metadata', {}) or {}
                work_name = str(meta.get('work_name') or p.get('work_name') or '-')
                self.comm_table.setItem(row, 1, QTableWidgetItem(work_name))
                
                # 2: User
                user = str(p.get('created_by') or p.get(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("user_id")))))) or '?') # Ideally verify joined name
                self.comm_table.setItem(row, 2, QTableWidgetItem(user[:8])) # Truncate UUID
                
                # 3: Data
                created = p.get('created_at', '-')[:10]
                self.comm_table.setItem(row, 3, QTableWidgetItem(created))

                # Stats Analysis (Live Count vs Saved Stats)
                # Se tiver stats salvos no metadata, usa. Sen√£o, tenta estimar usando o payload JSON (se dispon√≠vel)
                stats = meta.get('stats', {})
                
                if not stats and ('project_data' in p or 'content' in p):
                    # Tenta calcular on-the-fly se tivermos o JSON bruto
                    try:
                        raw_data = p.get('project_data') or p.get('content')
                        if isinstance(raw_data, str):
                            import json
                            raw_data = json.loads(raw_data)
                        
                        if isinstance(raw_data, dict):
                            _calc_items = 0
                            _calc_blue = 0
                            _calc_links_total = 0
                            _calc_links_valid = 0
                            
                            all_items = []
                            # Aggregate items from known layers/types
                            if 'pillars' in raw_data: all_items.extend(raw_data['pillars'])
                            if 'beams' in raw_data: all_items.extend(raw_data['beams'])
                            if 'slabs' in raw_data: all_items.extend(raw_data['slabs'])
                            # Legacy structure check
                            if not all_items and 'layers' in raw_data:
                                for layer in raw_data['layers'].values():
                                    all_items.extend(layer.get('items', []))
                                    
                            _calc_items = len(all_items)
                            
                            for item in all_items:
                                if item.get('is_fully_validated'): _calc_blue += 1
                                
                                # Heuristic Link Count
                                itype = 'pillar'
                                if 'section' in item: itype = 'pillar'
                                elif 'points' in item: itype = 'slab'
                                else: itype = 'beam'

                                expected = 10
                                if itype == 'pillar': expected = 12
                                elif itype == 'slab': expected = 6
                                elif itype == 'beam': expected = 10
                                
                                _calc_links_total += expected
                                
                                v_fields = item.get('validated_fields', {})
                                na_fields = item.get('na_fields', {})
                                valid_keys = set(v_fields.keys()) | set(na_fields.keys())
                                _calc_links_valid += len(valid_keys)
                            
                            stats = {
                                'total_items': _calc_items,
                                'blue_items': _calc_blue,
                                'total_links': _calc_links_total,
                                'green_links': _calc_links_valid
                            }
                            # Opcional: print para debug
                            print(f"[AdminDashboard] Calculated stats on-the-fly for {p_name}: {stats}")
                    except Exception as e:
                        print(f"[AdminDashboard] Failed to calc stats: {e}")

                # 4: Itens (Azul / Total)
                total_items = stats.get('total_items', int(meta.get('training_items_count', 0))) # Fallback
                blue_items = stats.get('blue_items', int(meta.get('fully_validated_count', 0)))
                
                self.comm_table.setCellWidget(row, 4, self._create_progress_bar(blue_items, total_items, "#00d4ff", "#007acc"))

                # 5: V√≠nculos (Verde / Total)
                total_links = stats.get('total_links', 0)
                green_links = stats.get('green_links', 0)
                self.comm_table.setCellWidget(row, 5, self._create_progress_bar(green_links, total_links, "#28a745", "#28a745"))

                # 6 & 7: Treino Nuvem (Itens e Links Treinados)
                # Como "Treino" √© o ato de salvar no Chroma, poderiamos ter uma m√©trica de "Vetores Gerados".
                # Por simplifica√ß√£o, vamos replicar os stats salvos (que representam o ultimo Snapshot de treino).
                
                # √öltimo Treino (Data) + Snapshot Itens
                last_train = meta.get('last_training_at', '-')
                if last_train != '-': 
                    # Coluna 6: Itens no Snapshot
                    self.comm_table.setCellWidget(row, 6, self._create_progress_bar(blue_items, total_items, "#6f42c1", "#6f42c1"))
                    # Coluna 7: Links no Snapshot
                    self.comm_table.setCellWidget(row, 7, self._create_progress_bar(green_links, total_links, "#6f42c1", "#6f42c1"))
                else:
                    self.comm_table.setItem(row, 6, QTableWidgetItem("-"))
                    self.comm_table.setItem(row, 7, QTableWidgetItem("-"))

                # 8: A√ß√µes
                actions_widget = QWidget()
                actions_layout = QHBoxLayout(actions_widget)
                actions_layout.setContentsMargins(2, 2, 2, 2)
                actions_layout.setSpacing(4)

                btn_import = QPushButton("‚¨áÔ∏è Treinar")
                btn_import.setStyleSheet("background: #2e7d32; border: 1px solid #444; color: white; font-weight: bold;")
                btn_import.clicked.connect(lambda checked=False, pid=p['id'], items=total_items: self.import_for_training(pid, items))
                
                btn_details = QPushButton("üîç Ficha")
                btn_details.setStyleSheet("background: #007acc; border: 1px solid #444; color: white;")
                btn_details.clicked.connect(lambda checked=False, proj=p: self.open_project_details(proj))

                actions_layout.addWidget(btn_import)
                actions_layout.addWidget(btn_details)
                
                self.comm_table.setCellWidget(row, 8, actions_widget)
                
            except Exception as e:
                print(f"Error row {row}: {e}")
                continue

        # 1. Update Metadata in Supabase
        from src.core.services.sync_service import SyncService
        from datetime import datetime
        
    def import_for_training(self, project_id, total_items_fallback):
        """Simula a importa√ß√£o para treino e atualiza o banco com estat√≠sticas reais."""
        print(f"Importing project {project_id} for training...")
        
        from src.core.services.sync_service import SyncService
        from datetime import datetime
        
        try:
            sync = SyncService()
            
            # 1. Fetch current full metadata
            res = sync.supabase.table("cloud_projects").select("metadata").eq("id", project_id).single().execute()
            current_meta = res.data.get('metadata') or {}
            
            # 2. Calculate Stats (Blue vs Green vs Total)
            pillars = current_meta.get('pillars', []) or []
            beams = current_meta.get('beams', []) or []
            slabs = current_meta.get('slabs', []) or []
            
            all_items = pillars + beams + slabs
            total_real = len(all_items)
            
            # Blue Seal (is_fully_validated == True)
            fully_valid = sum(1 for i in all_items if i.get('is_fully_validated'))
            
            # Green Seal (Not Blue, but has validated_fields)
            partially_valid = sum(1 for i in all_items if not i.get('is_fully_validated') and i.get('validated_fields'))
            
            print(f"Stats Calculated: Total={total_real}, Blue={fully_valid}, Green={partially_valid}")

            # 3. Update Metadata
            current_meta['last_training_at'] = datetime.now().isoformat()
            current_meta['training_items_count'] = total_real
            current_meta['fully_validated_count'] = fully_valid
            current_meta['partially_validated_count'] = partially_valid
            
            # 4. Push update
            sync.supabase.table("cloud_projects").update({"metadata": current_meta}).eq("id", project_id).execute()
            
            # Refresh UI
            self.load_community_projects()
            print(f"Training metadata updated for {project_id}")
            
        except Exception as e:
            print(f"Failed to import training data: {e}")
            import traceback
            traceback.print_exc()


    def open_project_details(self, project_data):
        """Abre a ficha t√©cnica do projeto"""
        # Se for necess√°rio buscar dados completos (caso o list n√£o traga o JSON completo de pillars/etc)
        # Por enquanto assumimos que 'project_data' tem o que precisamos ou buscaremos sob demanda.
        
        # O 'list_community_projects' traz tudo (*), ent√£o 'project_data' deve ter metadata completo.
        try:
            dialog = ProjectDetailsDialog(project_data, self)
            dialog.exec()
        except Exception as e:
            print(f"Erro ao abrir ficha t√©cnica: {e}")
            import traceback
            traceback.print_exc()
