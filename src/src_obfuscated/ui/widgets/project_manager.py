
# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str("script.google.com"): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str("macros/s/"): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str("AKfycbz"): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str("credit"): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str("saldo"): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str("consumo"): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("api_key"): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str("user_id"): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str("calcular_creditos"): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str("confirmar_consumo"): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str("consultar_saldo"): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str("debitar_creditos"): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str("CreditManager"): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str("obter_hwid"): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str("generate_signature"): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str("encrypt_string"): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str("decrypt_string"): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str("integrity_check"): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str("security_utils"): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str("https://"): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str("google.com"): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str("apps.script"): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str("script.google.com")): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("macros/s/")): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("AKfycbz")): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("credit")): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("saldo")): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consumo")): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("api_key")): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("user_id")): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("calcular_creditos")): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("confirmar_consumo")): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("consultar_saldo")): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("debitar_creditos")): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("CreditManager")): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("obter_hwid")): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("generate_signature")): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("encrypt_string")): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("decrypt_string")): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("integrity_check")): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("security_utils")): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("https://")): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("google.com")): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str("apps.script")): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str("script.google.com"))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("macros/s/"))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("AKfycbz"))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("credit"))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("saldo"))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consumo"))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("api_key"))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("user_id"))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos"))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo"))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo"))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos"))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("CreditManager"))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("obter_hwid"))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("generate_signature"))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("encrypt_string"))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("decrypt_string"))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("integrity_check"))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("security_utils"))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("https://"))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("google.com"))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str("apps.script"))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("script.google.com")))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("macros/s/")))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("AKfycbz")))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("credit")))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("saldo")))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consumo")))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("api_key")))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("user_id")))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos")))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo")))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo")))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos")))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("CreditManager")))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("obter_hwid")))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("generate_signature")))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("encrypt_string")))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("decrypt_string")))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("integrity_check")))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("security_utils")))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("https://")))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("google.com")))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("apps.script")))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)


# Helper de ofusca√ß√£o (adicionado automaticamente)
def _get_obf_str(key):
    """Retorna string ofuscada"""
    _obf_map = {
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("script.google.com"))))): base64.b64decode("=02bj5SZsd2bvdmL0BXayN2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("macros/s/"))))): base64.b64decode("vM3Lz9mcjFWb"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("AKfycbz"))))): base64.b64decode("==geiNWemtUQ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("credit"))))): base64.b64decode("0lGZlJ3Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("saldo"))))): base64.b64decode("=8GZsF2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consumo"))))): base64.b64decode("==wbtV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("api_key"))))): base64.b64decode("==Qelt2XpBXY"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("user_id"))))): base64.b64decode("==AZp9lclNXd"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("calcular_creditos"))))): base64.b64decode("=M3b0lGZlJ3YfJXYsV3YsF2Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("confirmar_consumo"))))): base64.b64decode("=8Wb1NnbvN2XyFWbylmZu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("consultar_saldo"))))): base64.b64decode("vRGbhN3XyFGdsV3cu92Y"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("debitar_creditos"))))): base64.b64decode("==wcvRXakVmcj9lchRXaiVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("CreditManager"))))): base64.b64decode("==gcldWYuFWT0lGZlJ3Q"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("obter_hwid"))))): base64.b64decode("==AZpdHafJXZ0J2b"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("generate_signature"))))): base64.b64decode("lJXd0Fmbnl2cfVGdhJXZuV2Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("encrypt_string"))))): base64.b64decode("=cmbpJHdz9Fdwlncj5WZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("decrypt_string"))))): base64.b64decode("=cmbpJHdz9FdwlncjVGZ"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("integrity_check"))))): base64.b64decode("rNWZoN2X5RXaydWZ05Wa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("security_utils"))))): base64.b64decode("=MHbpRXdflHdpJXdjV2c"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("https://"))))): base64.b64decode("=8yL6MHc0RHa"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("google.com"))))): base64.b64decode("==QbvNmLlx2Zv92Z"[::-1].encode()).decode(),
        _get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str(_get_obf_str("apps.script"))))): base64.b64decode("=QHcpJ3Yz5ycwBXY"[::-1].encode()).decode(),
    }
    return _obf_map.get(key, key)

from PySide6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QListWidget, 
                               QPushButton, QLabel, QLineEdit, QFileDialog, QMessageBox, 
                               QListWidgetItem, QTableWidget, QTableWidgetItem, QHeaderView,
                               QComboBox, QInputDialog, QMenu, QToolButton, QTabWidget,
                               QFrame, QScrollArea, QSplitter)
from PySide6.QtCore import Signal, Qt, QSize
import json
import os
import logging
from datetime import datetime
from src.core.services.auth_service import AuthService
from src.core.services.sync_service import SyncService
from src.ui.widgets.admin_dashboard import AdminDashboard

class ProjectManager(QWidget):
    project_selected = Signal(str, str, str)  # id, name, dxf_path
    project_created_globally = Signal(str, str) # work_name, project_name
    obra_created_globally = Signal(str) # work_name
    sync_complete_signal = Signal(bool, str) # success, project_id

    def __init__(self, db_manager, memory_manager=None):
        super().__init__()
        self.db = db_manager
        self.memory = memory_manager
        self.sync_complete_signal.connect(self._on_sync_complete)
        
        # Window Setup
        self.setWindowTitle("Gerenciador de Projetos - Vision AI")
        self.resize(1400, 900)
        self.setWindowFlags(Qt.Window) # Force top-level window behavior
        self.setWindowState(Qt.WindowMaximized)
        
        self.apply_styles()
        self.setup_ui()
        self.load_works_combo()
        self.load_projects()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #1a1a1a;
                color: #e0e0e0;
                font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            }
            
            QTabWidget::pane {
                border: 1px solid #333;
                background: #1e1e1e;
                border-radius: 8px;
            }
            
            QTabBar::tab {
                background: #252525;
                color: #888;
                padding: 10px 20px;
                border-top-left-radius: 6px;
                border-top-right-radius: 6px;
                margin-right: 2px;
            }
            
            QTabBar::tab:selected {
                background: #333;
                color: #fff;
                font-weight: bold;
                border-bottom: 2px solid #007acc;
            }
            
            QTableWidget {
                background-color: #252525;
                gridline-color: #333;
                border: none;
                selection-background-color: #007acc22;
                selection-color: white;
            }
            
            QTableWidget::item:selected {
                background-color: #007acc44;
                border-left: 3px solid #007acc;
            }
            
            #DetailPanel {
                background-color: #1e1e1e;
                border-left: 2px solid #2d2d2d;
            }
            
            #DetailTitle {
                font-size: 22px;
                font-weight: bold;
                color: #007acc;
                margin-bottom: 10px;
            }
            
            QPushButton#PrimaryButton {
                background-color: #007acc;
                color: white;
                font-weight: bold;
                padding: 8px 16px;
                border-radius: 4px;
            }
            
            QPushButton#PrimaryButton:hover {
                background-color: #0098ff;
            }
            
            QPushButton#BigOpenButton {
                background-color: #28a745;
                color: white;
                font-size: 16px;
                font-weight: bold;
                padding: 12px;
                border-radius: 6px;
                margin: 10px 0;
            }
            
            QPushButton#BigOpenButton:hover {
                background-color: #34ce57;
            }
            
            #FilterFrame {
                background: #2d2d2d;
                border-radius: 6px;
                margin-bottom: 10px;
            }
            
            QComboBox {
                border: 1px solid #444;
                border-radius: 4px;
                padding: 5px;
                background: #333;
            }
        """)

    def setup_ui(self):
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(0, 0, 0, 0)
        self.layout.setSpacing(0)

        # 1. Main Tabs
        self.tabs = QTabWidget()
        self.tabs.setObjectName("ProjectTabs")
        
        # Tab: Meus Projetos
        self.local_tab = QWidget()
        self.setup_local_tab()
        self.tabs.addTab(self.local_tab, "üìÅ Meus Projetos")
        
        # Tab: Comunidade (Curadoria) - Hidden for non-admins
        auth = AuthService()
        user = auth.get_current_user()
        is_admin = user and (user.role == 'admin' or user.email == 'thierry.tasf@gmail.com')
        
        if is_admin:
            self.community_tab = QWidget()
            self.setup_community_tab()
            self.tabs.addTab(self.community_tab, "üõ°Ô∏è Curadoria (Admin)")
            
        self.layout.addWidget(self.tabs)

    def setup_local_tab(self):
        layout = QHBoxLayout(self.local_tab)
        layout.setContentsMargins(10, 10, 10, 10)
        
        # Splitter: Master (Left) | Detail (Right)
        self.local_splitter = QSplitter(Qt.Horizontal)
        
        # --- LEFT: MASTER LIST ---
        master_widget = QWidget()
        master_layout = QVBoxLayout(master_widget)
        
        # Filter Header
        filter_frame = QFrame()
        filter_frame.setObjectName("FilterFrame")
        filter_layout = QHBoxLayout(filter_frame)
        
        self.combo_works = QComboBox()
        self.combo_works.addItem("Todas as Obras", None)
        self.combo_works.currentIndexChanged.connect(self.load_projects)
        filter_layout.addWidget(self.combo_works)
        
        btn_add_work = self._make_action_btn("‚ûï", "Nova Obra", self.add_work)
        filter_layout.addWidget(btn_add_work)
        
        master_layout.addWidget(filter_frame)
        
        # Project Table
        self.table = QTableWidget()
        self.table.setColumnCount(7)
        self.table.setHorizontalHeaderLabels(["Nome", "Obra", "Autor", "Itens", "Modificado", "Nuvem", "Status"])
        self.table.horizontalHeader().setSectionResizeMode(0, QHeaderView.Stretch)
        self.table.horizontalHeader().setSectionResizeMode(3, QHeaderView.ResizeToContents) # Allot space for Itens
        self.table.setSelectionBehavior(QTableWidget.SelectRows)
        self.table.setSelectionMode(QTableWidget.SingleSelection)
        self.table.itemSelectionChanged.connect(self.on_selection_changed)
        self.table.cellDoubleClicked.connect(self.on_table_double_click)
        master_layout.addWidget(self.table)
        
        # Bottom Actions
        actions_bar = QHBoxLayout()
        self.btn_new = QPushButton("Novo Projeto")
        self.btn_new.setObjectName("PrimaryButton")
        self.btn_new.clicked.connect(self.create_new_project)
        actions_bar.addWidget(self.btn_new)
        
        self.btn_import = QPushButton("Importar")
        self.btn_import.clicked.connect(self.import_project)
        actions_bar.addWidget(self.btn_import)
        
        master_layout.addLayout(actions_bar)
        
        # --- RIGHT: DETAIL PANEL ---
        self.detail_panel = QFrame()
        self.detail_panel.setObjectName("DetailPanel")
        self.detail_layout = QVBoxLayout(self.detail_panel)
        
        self.lbl_no_selection = QLabel("Selecione um projeto para ver detalhes")
        self.lbl_no_selection.setAlignment(Qt.AlignCenter)
        self.lbl_no_selection.setStyleSheet("color: #666; font-style: italic;")
        self.detail_layout.addWidget(self.lbl_no_selection)
        
        # Detail Content (Hidden until selection)
        self.detail_content = QWidget()
        self.detail_content_layout = QVBoxLayout(self.detail_content)
        self.detail_content.hide()
        
        self.lbl_proj_title = QLabel("Nome do Projeto")
        self.lbl_proj_title.setObjectName("DetailTitle")
        self.detail_content_layout.addWidget(self.lbl_proj_title)
        
        self.lbl_proj_info = QLabel("Detalhes t√©cnicos aqui...")
        self.lbl_proj_info.setWordWrap(True)
        self.detail_content_layout.addWidget(self.lbl_proj_info)
        
        self.detail_content_layout.addStretch()
        
        # Detailed Action Buttons
        self.btn_open = QPushButton("üöÄ Abrir Projeto")
        self.btn_open.setObjectName("BigOpenButton")
        self.btn_open.clicked.connect(self.open_selected_project)
        self.detail_content_layout.addWidget(self.btn_open)
        
        self.btn_sync_now = QPushButton("‚òÅÔ∏è Sincronizar com Nuvem")
        self.btn_sync_now.clicked.connect(self.sync_selected_to_cloud)
        self.detail_content_layout.addWidget(self.btn_sync_now)
        
        btn_exp = QPushButton("üíæ Exportar Backup")
        btn_exp.clicked.connect(self.export_project)
        self.detail_content_layout.addWidget(btn_exp)

        # Remove Button (Local Only)
        btn_del = QPushButton("üóëÔ∏è Remover do Computador")
        btn_del.setStyleSheet("background-color: #d32f2f; color: white; margin-top: 10px;")
        btn_del.clicked.connect(self.remove_selected_local)
        self.detail_content_layout.addWidget(btn_del)
        
        self.detail_layout.addWidget(self.detail_content)

        
        # Assembler Splitter
        self.local_splitter.addWidget(master_widget)
        self.local_splitter.addWidget(self.detail_panel)
        self.local_splitter.setStretchFactor(0, 2)
        self.local_splitter.setStretchFactor(1, 1)
        layout.addWidget(self.local_splitter)

    def setup_community_tab(self):
        layout = QVBoxLayout(self.community_tab)
        layout.setContentsMargins(0, 0, 0, 0)
        
        # Admin Dashboard replaces the simple table
        self.admin_dashboard = AdminDashboard(self.db, self.memory)
        layout.addWidget(self.admin_dashboard)
        
    def load_community_projects(self):
        # Forward to admin dashboard
        if hasattr(self, 'admin_dashboard'):
            self.admin_dashboard.load_community_projects()

    def _make_action_btn(self, icon, tool_tip, callback):
        btn = QPushButton(icon)
        btn.setToolTip(tool_tip)
        btn.setFixedSize(32, 32)
        btn.clicked.connect(callback)
        return btn

    def load_works_combo(self):
        curr_text = self.combo_works.currentText()
        self.combo_works.blockSignals(True)
        self.combo_works.clear()
        self.combo_works.addItem("Todas as Obras", None)
        
        works = self.db.get_all_works()
        for w in works:
            self.combo_works.addItem(w, w)
            
        # Restore selection
        idx = self.combo_works.findText(curr_text)
        if idx >= 0:
            self.combo_works.setCurrentIndex(idx)
        else:
            self.combo_works.setCurrentIndex(0)
            
        self.combo_works.blockSignals(False)

    def load_projects(self):
        self.table.setRowCount(0)
        try:
            projects = self.db.get_projects()
        except Exception as e:
            logging.error(f"load_projects failed: {e}")
            return
            
        logging.debug(f"Loaded {len(projects)} projects.")
        
        filter_work = self.combo_works.currentData() # None = All
        
        row = 0
        for p in projects:
            logging.debug(f"Proj {p.get('name')} | ID={p.get('id')} | SyncAt={p.get('last_sync_at')}")
            p_work = p.get('work_name') or "Sem Obra"
            if filter_work and p.get('work_name') != filter_work:
                continue

            self.table.insertRow(row)
            
            # Name
            self.table.setItem(row, 0, QTableWidgetItem(p['name']))
            # Work
            self.table.setItem(row, 1, QTableWidgetItem(p_work))
            
            # Author
            p_author = p.get('author_name') or "Local"
            self.table.setItem(row, 2, QTableWidgetItem(p_author))

            # Items Stats
            # User format: Pilares- 22/74 (progresso...)
            # "Pilares: 22/74 | Vigas: 33/112 | Lajes: 22/33"
            p_stats = f"Pilares: {p.get('pil_valid')}/{p.get('pil_total')} | Vigas: {p.get('beam_valid')}/{p.get('beam_total')} | Lajes: {p.get('slab_valid')}/{p.get('slab_total')}"
            self.table.setItem(row, 3, QTableWidgetItem(p_stats))

            # Dates
            updated = str(p.get('updated_at') or '')[:16]
            synced = str(p.get('last_sync_at') or '-')[:16]
            self.table.setItem(row, 4, QTableWidgetItem(updated))
            self.table.setItem(row, 5, QTableWidgetItem(synced))

            # Sync Status Icon
            status = p.get('sync_status') or "pending"
            status_icon = "‚òÅÔ∏è" if status == 'synced' else "üíª"
            self.table.setItem(row, 6, QTableWidgetItem(f"{status_icon} {status}"))
            
            # Store ID in hidden role
            self.table.item(row, 0).setData(Qt.UserRole, p)
            row += 1

    def on_selection_changed(self):
        row = self.table.currentRow()
        if row < 0:
            self.lbl_no_selection.show()
            self.detail_content.hide()
            return
            
        self.lbl_no_selection.hide()
        self.detail_content.show()
        
        p = self.table.item(row, 0).data(Qt.UserRole)
        self.lbl_proj_title.setText(f"üìò {p['name']}")
        
        info_text = (
            f"<b>üìç Caminho:</b> {p['dxf_path']}<br>"
            f"<b>üè¢ Obra:</b> {p.get('work_name') or 'Sem Obra'}<br>"
            f"<b>üë§ Autor:</b> {p.get('author_name') or 'Local'}<br>"
            f"<b>üïí Criado:</b> {str(p.get('created_at'))[:19]}<br>"
            f"<b>üìÖ Atualizado:</b> {str(p.get('updated_at'))[:19]}<br>"
            f"<b>üì∂ Status Sync:</b> {p.get('sync_status') or 'pending'}"
        )
        self.lbl_proj_info.setText(info_text)

    def sync_selected_to_cloud(self):
        row = self.table.currentRow()
        if row < 0: return

        p = self.table.item(row, 0).data(Qt.UserRole)
        
        # Export data for sync
        data = self.db.export_project_data(p['id'])
        if not data:
            QMessageBox.critical(self, "Erro", "N√£o foi poss√≠vel preparar dados para sincroniza√ß√£o.")
            return

        auth = AuthService()
        session = auth.get_session()
        if not session:
            QMessageBox.warning(self, "Login Necess√°rio", "Voc√™ precisa estar logado para sincronizar.")
            return

        sync = SyncService()
        self.btn_sync_now.setEnabled(False)
        self.btn_sync_now.setText("‚è≥ Sincronizando...")
        
        import threading
        def do_sync():
            try:
                logging.debug(f"Starting sync thread for {p['id']}")
                success = sync.sync_project(data, session)
                logging.debug(f"Sync finished. Success={success}. Emitting signal.")
                self.sync_complete_signal.emit(success, p['id'])
            except Exception as e:
                logging.error(f"Thread died: {e}")
                self.sync_complete_signal.emit(False, p['id'])

        threading.Thread(target=do_sync, daemon=True).start()

    def _on_sync_complete(self, success, project_id):
        logging.debug(f"_on_sync_complete called for {project_id}, success={success}")
        if success:
            # Mark as synced in local DB
            self.db.update_project_sync_status(project_id, 'synced')
            QMessageBox.information(self, "Sucesso", "Projeto sincronizado com sucesso!")
        else:
            QMessageBox.critical(self, "Erro", "Falha na sincroniza√ß√£o.")
        
        self.btn_sync_now.setEnabled(True)
        self.btn_sync_now.setText("‚òÅÔ∏è Sincronizar com Nuvem")
        self.load_projects()

    def load_community_projects(self):
        if not hasattr(self, 'comm_table'): return
        
        self.comm_table.setRowCount(0)
        sync = SyncService()
        projects = sync.list_community_projects()
        
        for i, p in enumerate(projects):
            self.comm_table.insertRow(i)
            self.comm_table.setItem(i, 0, QTableWidgetItem(p['project_name']))
            
            # Obra from metadata
            meta = p.get('metadata', {})
            remote_work = meta.get('work_name', 'Sem Obra')
            self.comm_table.setItem(i, 1, QTableWidgetItem(remote_work))

            # Email from metadata or joined table
            user_email = meta.get('user_email') or p.get('profiles', {}).get('email', 'Desconhecido')
            self.comm_table.setItem(i, 2, QTableWidgetItem(user_email))
            
            self.comm_table.setItem(i, 3, QTableWidgetItem(str(p['created_at'])[:16]))
            
            # Stats item
            stats = f"P:{meta.get('num_pillars',0)} V:{meta.get('num_beams',0)} L:{meta.get('num_slabs',0)}"
            self.comm_table.setItem(i, 4, QTableWidgetItem(stats))
            
            # Download Action
            btn_dl = QPushButton("üì• Baixar Curadoria")
            btn_dl.clicked.connect(lambda checked=False, path=p['storage_path'], name=p['project_name']: self.download_for_curation(path, name))
            self.comm_table.setCellWidget(i, 5, btn_dl)

    def download_for_curation(self, storage_path, project_name):
        sync = SyncService()
        data = sync.download_project(storage_path)
        if data:
            # Import to local DB
            # We might want to prefix the name with [CURadoria]
            data['project']['name'] = f"[CUR] {project_name}"
            pid = self.db.import_project_data(data)
            if pid:
                QMessageBox.information(self, "Curadoria", "Projeto baixado e importado para 'Meus Projetos'. Voc√™ j√° pode abri-lo para revis√£o.")
                self.tabs.setCurrentIndex(0)
                self.load_projects()
            else:
                QMessageBox.critical(self, "Erro", "Falha ao importar dados curados.")
        else:
            QMessageBox.critical(self, "Erro", "N√£o foi poss√≠vel baixar o projeto.")

    def _make_tool_btn(self, icon_text, tooltip, callback):
        btn = QToolButton()
        btn.setText(icon_text)
        btn.setToolTip(tooltip)
        btn.clicked.connect(callback)
        btn.setFixedSize(24, 24)
        return btn

    # --- Actions ---

    def add_work(self):
        text, ok = QInputDialog.getText(self, "Nova Obra", "Nome da Obra:")
        if ok and text:
            self.db.create_work(text)
            self.obra_created_globally.emit(text)
            self.load_works_combo()
            
            # Select the new work
            idx = self.combo_works.findText(text)
            if idx >= 0:
                self.combo_works.setCurrentIndex(idx)

    def rename_current_work(self):
        current_work = self.combo_works.currentData()
        if not current_work:
            QMessageBox.warning(self, "Aviso", "Selecione uma Obra espec√≠fica para renomear.")
            return
            
        new_name, ok = QInputDialog.getText(self, "Renomear Obra", f"Novo nome para '{current_work}':", text=current_work)
        if ok and new_name and new_name != current_work:
            self.db.rename_work(current_work, new_name)
            self.load_works_combo()
            self.load_projects()
            
            # Restore selection
            idx = self.combo_works.findText(new_name)
            if idx >= 0: self.combo_works.setCurrentIndex(idx)

    def delete_current_work(self):
        current_work = self.combo_works.currentData()
        if not current_work:
            return
            
        reply = QMessageBox.question(self, "Excluir Obra", 
                                     f"Isso remover√° a Obra '{current_work}' e seus projetos ficar√£o 'Sem Obra'.\nContinuar?",
                                     QMessageBox.Yes | QMessageBox.No)
        
        if reply == QMessageBox.Yes:
            self.db.delete_work(current_work)
            self.load_works_combo()
            self.load_projects()

    def rename_project_action(self, pid, old_name):
        new_name, ok = QInputDialog.getText(self, "Renomear Projeto", "Novo Nome:", text=old_name)
        if ok and new_name:
            self.db.rename_project(pid, new_name)
            self.load_projects()

    def delete_project_action(self, pid, name):
        reply = QMessageBox.question(self, "Confirmar Exclus√£o", 
                                     f"Tem certeza que deseja excluir o projeto '{name}'?\nIsso apagar√° TODOS os dados (Pilares, Lajes, etc).",
                                     QMessageBox.Yes | QMessageBox.No)
        if reply == QMessageBox.Yes:
            self.db.delete_project_fully(pid)
            self.load_projects()

    def move_copy_project_action(self, pid):
        # Dialog to choose Target Work and Action (Move vs Copy)
        works = self.db.get_all_works()
        if not works:
            QMessageBox.warning(self, "Aviso", "N√£o h√° obras cadastradas para destino.")
            return

        item, ok = QInputDialog.getItem(self, "Selecionar Obra de Destino", "Obra:", works, 0, False)
        if ok and item:
            # Ask Move or Copy
            msg = QMessageBox()
            msg.setWindowTitle("A√ß√£o")
            msg.setText(f"O que deseja fazer com o projeto para '{item}'?")
            btn_move = msg.addButton("Mover", QMessageBox.ActionRole) # Role 0
            btn_copy = msg.addButton("Copiar", QMessageBox.ActionRole) # Role 1
            msg.addButton("Cancelar", QMessageBox.RejectRole)
            
            msg.exec_()
            
            if msg.clickedButton() == btn_move:
                self.db.update_project_work(pid, item)
                self.load_projects()
            elif msg.clickedButton() == btn_copy:
                new_pid = self.db.duplicate_project(pid, target_work_name=item)
                if new_pid:
                    QMessageBox.information(self, "Sucesso", "Projeto copiado com sucesso!")
                    self.load_projects()
                else:
                    QMessageBox.critical(self, "Erro", "Falha ao copiar projeto.")


    def create_new_project(self):
        # Capture context BEFORE async/dialogs
        curr_work = self.combo_works.currentData()

        # 1. Select DXF
        fname, _ = QFileDialog.getOpenFileName(self, "Selecionar DXF", "", "DXF Files (*.dxf)")
        if not fname:
            return

        # --- INTERNAL REPO LOGIC ---
        # Garantir que o projeto seja copiado para o reposit√≥rio interno
        import shutil
        repo_dir = os.path.join(os.getcwd(), 'projects_repo')
        if not os.path.exists(repo_dir):
            try:
                os.makedirs(repo_dir)
            except OSError as e:
                QMessageBox.critical(self, "Erro", f"Falha ao criar diret√≥rio de projetos: {e}")
                return

        base_name = os.path.basename(fname)
        target_path = os.path.join(repo_dir, base_name)
        
        # Se arquivo j√° existe, gerar nome √∫nico para evitar conflitos silenciosos
        if os.path.exists(target_path):
            name, ext = os.path.splitext(base_name)
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            target_path = os.path.join(repo_dir, f"{name}_{timestamp}{ext}")

        try:
            shutil.copy2(fname, target_path)
            fname = target_path # Atualiza fname para usar o caminho interno
        except Exception as e:
            QMessageBox.critical(self, "Erro", f"Erro ao copiar DXF para o sistema: {e}")
            return
        # ---------------------------

        # 2. Name Project
        project_name = os.path.splitext(os.path.basename(fname))[0]
        
        # 3. Create ID
        # Get Current Author
        auth = AuthService()
        user = auth.get_current_user()
        author_name = user.email if user else "Local"
        
        pid = self.db.create_project(project_name, fname, author_name=author_name)
        if pid:
            if curr_work:
                self.db.update_project_work(pid, curr_work)
                
            self.load_projects()
            self.project_selected.emit(pid, project_name, fname)
            
            # Emitir para sincroniza√ß√£o global
            work_name = curr_work if curr_work else "Sem Obra"
            self.project_created_globally.emit(work_name, project_name)
        else:
            QMessageBox.critical(self, "Erro", "Falha ao criar projeto no banco de dados.")

    def open_selected_project(self):
        row = self.table.currentRow()
        if row < 0: return
        
        p = self.table.item(row, 0).data(Qt.UserRole)
        self.project_selected.emit(p['id'], p['name'], p['dxf_path'])

    def on_table_double_click(self, row, col):
        if col == 3: return # Actions column
        self.open_selected_project()

    def export_project(self):
        row = self.table.currentRow()
        if row < 0:
            QMessageBox.warning(self, "Aviso", "Selecione um projeto para exportar.")
            return

        p = self.table.item(row, 0).data(Qt.UserRole)
        data = self.db.export_project_data(p['id'])
        
        if not data:
            QMessageBox.critical(self, "Erro", "N√£o foi poss√≠vel recuperar os dados do projeto.")
            return

        # Suggested filename
        safe_name = p['name'].replace(" ", "_").replace("/", "-")
        fname, _ = QFileDialog.getSaveFileName(self, "Salvar Backup de Projeto", f"{safe_name}_backup.cadproj", "Project Files (*.cadproj *.json)")
        if fname:
            try:
                with open(fname, 'w', encoding='utf-8') as f:
                    json.dump(data, f, indent=4, ensure_ascii=False)
                QMessageBox.information(self, "Sucesso", "Projeto exportado com sucesso!")
            except Exception as e:
                QMessageBox.critical(self, "Erro", f"Erro ao salvar arquivo: {e}")

    def remove_selected_local(self):
        row = self.table.currentRow()
        if row < 0: return
        
        p = self.table.item(row, 0).data(Qt.UserRole)
        name = p['name']
        pid = p['id']
        
        reply = QMessageBox.question(self, "Remover Projeto", 
                                     f"Isso remover√° '{name}' DESTE computador.\nSe estiver sincronizado, a c√≥pia na nuvem PERMANECE.\n\nContinuar?",
                                     QMessageBox.Yes | QMessageBox.No)
        
        if reply == QMessageBox.Yes:
            # Local Delete Only
            self.db.delete_project_fully(pid)
            QMessageBox.information(self, "Sucesso", "Projeto removido da lista local.")
            self.load_projects()
            self.lbl_no_selection.show()
            self.detail_content.hide()

    def import_project(self):
        fname, _ = QFileDialog.getOpenFileName(self, "Importar Backup", "", "Project Files (*.cadproj *.json)")
        if not fname: return

        try:
            with open(fname, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # --- FEATURE REQUEST: Use document name as saved at time of export ---
            # DB export saves data['project']['name']. DatabaseManager.import_project_data uses it.
            # So this is already handled if the export file contains the correct name.
            # But the user said: "importing... save with the name of the document saved AT THE TIME OF EXPORT"
            # Yes, data['project']['name'] IS the name at time of export. 
            # So I just pass data to DB.
            # However, I should check if the user wants to *override* the imported work name with current UI selection?
            # User didn't specify that. He said project name.
            
            # Additional: Ensure it appears in current "Obra" if one is selected and strict?
            # Or just import as is? I'll import as is.
            
            # Optional: If current Obra filter is active, maybe ask to auto-assign?
            # I'll stick to raw import.
            
            p_id = self.db.import_project_data(data)
            
            if p_id:
                self.load_works_combo() # In case a new work was imported
                self.load_projects()
                QMessageBox.information(self, "Sucesso", f"Projeto '{data['project']['name']}' importado com sucesso!")
            else:
                QMessageBox.critical(self, "Erro", "Falha estrutural ao importar projeto.")
                
        except Exception as e:
            QMessageBox.critical(self, "Erro", f"Erro ao ler arquivo de projeto: {e}")
